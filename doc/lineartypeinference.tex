\title{
	Notes on linear type inference
}
\author{
	Henri Chataing
}
\date{\today}

\documentclass[10pt]{article}

\usepackage[margin=1.5in]{geometry}
\usepackage[utf8]{inputenc}
\usepackage{amsthm}
\usepackage{amsmath}
\usepackage{amssymb}

\usepackage{bussproofs}

\theoremstyle{plain}
\newtheorem{thm}{Theorem}[section] % reset theorem numbering for each chapter

\theoremstyle{definition}
\newtheorem{defn}{Definition}[subsection] % definition numbers are dependent on theorem numbers
\newtheorem{exmp}{Example} % same for example numbers
\newtheorem{prop}{Proposition}[section]
\newtheorem{lemma}{Lemma}[section]
\newtheorem{coro}{Corollary}

%% LINEAR LOGIC %%
\def\bang{\,!\,}
\newcommand{\pair}[2]{\langle #1, #2 \rangle}

\begin{document}
\maketitle
\newpage

\tableofcontents
\newpage

\section{Linear logic}

\subsection{Definition of the language LL}

\begin{defn} The terms of the language are defined by the following grammar :
	$$\texttt{Term} ~ t, u ~ ::= ~ x ~ | ~ \lambda x.t ~ | ~ t u ~|~ \pair{t}{u} ~|~ \text{let} ~ \pair{x}{y} = t ~ \text{in} ~ u  $$
	The free variables of a term are given by the function $FV$.
\end{defn}

\begin{defn} The types of language are defined by the following grammar :
	\begin{center}
		$\texttt{Type} ~ T, U ~ ::= ~ \alpha ~|~ T \multimap U ~|~ T \otimes U ~|~ \bang U$
	\end{center}
	$\alpha$ is a type variable, of which we have an infinite number.
	We use the notation $FTV$ for the free type variables of a type.
\end{defn}

\begin{defn}
	The sub-typing relation $<:$ is the smallest relation on LL types satisfying the following rules :
	\begin{prooftree}
  	\AxiomC{}
  	\RightLabel{$(var)$}
  	\UnaryInfC{$\alpha <: ~ \alpha$}
  \end{prooftree}
  \begin{prooftree}	
  	\AxiomC{$A <: B$}
  	\RightLabel{$(!)$}
  	\UnaryInfC{$!^n A <: ~ !^m B$}
  \end{prooftree}
  \begin{prooftree}
  	\AxiomC{$T' <: T$}
  	\AxiomC{$U <: U'$}
  	\RightLabel{$(\multimap)$}
  	\BinaryInfC{$T \multimap U <: T' \multimap U'$}
  \end{prooftree}
  \begin{prooftree}
  	\AxiomC{$T <: T'$}
  	\AxiomC{$U <: U'$}
  	\RightLabel{$(\otimes)$}
  	\BinaryInfC{$T \otimes U <: T' \otimes U'$}
  \end{prooftree}
  under the condition that $m \le n$. In the rule for $(!)$, the types $A$ and $B$ are linear (not banged)
\end{defn}

\begin{lemma} \it The sub-typing relation $<:$ is reflexive, transitive.
\end{lemma}

\begin{defn}{\bf Typing rules}
	\begin{prooftree}
		\AxiomC{$T <: U$}
		\RightLabel{$(ax)$}
			\UnaryInfC{$! \Delta, x : T \vdash x : U$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma, x : T \vdash t : U$}
		\RightLabel{$(\lambda_1)$}
		\UnaryInfC{$\Gamma \vdash \lambda x.t : T \multimap U$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$! \Gamma, x : T \vdash t : U$}
		\RightLabel{$(\lambda_2)$}
		\UnaryInfC{$! \Gamma \vdash \lambda x.t : ~ !^{n+1} (T \multimap U)$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma_1, !\Delta \vdash t : T \multimap U$}
		\AxiomC{$\Gamma_2, !\Delta \vdash u : T$}
		\RightLabel{$(app)$}
		\BinaryInfC{$\Gamma_1, \Gamma_2, !\Delta \vdash t u : U$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma_1, !\Delta \vdash t : \, !^nT$}
		\AxiomC{$\Gamma_2, !\Delta \vdash u : \, !^nU$}
		\RightLabel{$(\otimes.I)$}
		\BinaryInfC{$\Gamma_1, \Gamma_2, !\Delta \vdash \, \pair{t}{u} \, : \,!^n(T \otimes U)$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma_1, !\Delta \vdash t : \, !^n (T \otimes U)$}
		\AxiomC{$\Gamma_2, !\Delta, x : \,!^nT, y : \,!^nU \vdash u : V$}
		\RightLabel{$(\otimes.E)$}
		\BinaryInfC{$\Gamma_1, \Gamma_2, !\Delta \vdash \, \text{let} \pair{t}{u} = t ~ \text{in} ~ u \, : V$}
	\end{prooftree}
\end{defn}

\begin{lemma}
	\label{sub-judgement}
	Let $\Gamma \vdash t : T$ be a valid typing judgement in LL. Let $\Delta$ and $U$ be such that
	$\Delta <: \Gamma$ and $T <: U$. Then $\Delta \vdash t : U$ is a valid typing judgement as well.
\end{lemma}

\begin{coro} The following typing rule is admissible in LL
	\begin{prooftree}
		\AxiomC{$\Gamma \vdash t : T$}
		\AxiomC{$T <: U$}
		\RightLabel{(sub-typing)}
		\BinaryInfC{$\Gamma \vdash t : U$}
	\end{prooftree}
\end{coro}

\subsection{Linear logic adapted to the type inference : LL'}

The terms of the language are unchanged, only the typing system is modified to be closer to the
type inference algorithm. In particular, the indeterminism introduced by the presence of two different
typing rules $(\lambda_1)$ and $(\lambda_2)$ to type $\lambda$-expressions disappears.

\begin{defn} The types of LL' are defined by the following grammar :
	\begin{center}
	\begin{tabular}{l}
		$\texttt{Flag} ::= ~ n ~|~ 0 ~|~ 1$ \\		
		$\texttt{LinearType} ~ A ~ ::= ~ \alpha ~|~ T \multimap U ~|~ T \otimes U$ \\
		$\texttt{Type	} ~	T, U ~ ::= ~ !^n A$
	\end{tabular}
	\end{center}
	The variables $n, m \dots$ are flag variables, and can take either the value $0$ or $1$.
	Note that the grammar of the types of LL' forces every type to be preceded by a flag annotation.
	In the rest of these notes, the names $A$, $B \dots$ we will be used to designate linear types, and
	$T$, $U \dots$ types.
\end{defn}

\begin{defn}
  The sub-typing relation $<:$ is defined as the smallest relation on LL' types (and linear types) satisfying the rules
  \begin{prooftree}
  	\AxiomC{}
  	\RightLabel{$(var)$}
  	\UnaryInfC{$\alpha <: \alpha$}
  \end{prooftree}
  \begin{prooftree}
  	\AxiomC{$m \le n$}
  	\AxiomC{$A <: B$}
  	\RightLabel{$(!)$}
  	\BinaryInfC{$!^n A <: ~ !^m B$}
  \end{prooftree}
  \begin{prooftree}
  	\AxiomC{$T' <: T$}
  	\AxiomC{$U <: U'$}
  	\RightLabel{$(\multimap)$}
  	\BinaryInfC{$T \multimap U <: T' \multimap U'$}
  \end{prooftree}
  \begin{prooftree}
  	\AxiomC{$T <: T'$}
  	\AxiomC{$U <: U'$}
  	\RightLabel{$(\otimes)$}
  	\BinaryInfC{$T \otimes U <: T' \otimes U'$}
  \end{prooftree}
\end{defn}

\begin{lemma} \it The sub-typing relation $<:$ is reflexive, transitive.
\end{lemma}

\begin{defn} Sub-typing constraints $T <: U$ are defined over LL' types and linear types. A constraint $T <: U$ is atomic
  when $T$ and $U$ are both type variables, and composite when both are not. Otherwise, the constraint is semi-composite. \\
  Similarly, flag constraints $n \le m$ are defined over flag variables. Though all flag constraints are written in the same
  form, they can hold different meanings, for example $n \le 0$ is the constraint $n = 0$, $1 \le m$ is the constraint
  $m = 1$, and $n \le m$ is the constraint $n = 1 \Rightarrow m = 1$.
  
\end{defn}

\begin{defn} A substitution $\sigma$ is a pair of a finite list of mappings $\alpha \mapsto A$ from type variables to
	\textit{linear} types 	and finite list of mappings from flag constraints to either $0$ or $1$.
	A substitution is automatically extended with identity mappings to apply on all type and flag variables.
	$\bar{\sigma}$ the extension of $\sigma$ to linear and non-linear types is defined as follow :
 		\begin{center}
 		\begin{tabular}{l}
 			$\bar{\sigma}(\alpha) = \sigma(\alpha)$ \\
 			$\bar{\sigma}(T \multimap U) = \bar{\sigma}T \multimap \bar{\sigma}U$ \\
 			$\bar{\sigma}(T \otimes U) = \bar{\sigma}T \otimes \bar{\sigma}U$ \\
 			$\bar{\sigma}(!^n A) = ~ !^{\sigma(n)} \bar{\sigma}A$
 		\end{tabular}
 		\end{center}
 	A substitution $\sigma$ is $\textit{complete}$ with regard to a set of flag variables $\mathcal{F}$ if for every flag $n \in \mathcal{F}$,
 	$\sigma (n) = 0$ or $\sigma (n) = 1$.
 	
 	The notation $|\sigma|$ is used to designate the set of mapped type variables, for example
 	$ | \,x \mapsto T, \, y \mapsto U\,| = \{ x, \,y \} $
\end{defn}

\begin{defn} We name $\mathcal{L}$ a set of constraints, which is comprised of sub-typing constraints
  and flag constraints. A constraint set can have the following properties :
  \begin{itemize}
  	\item[]{\bf Atomicity} A set is atomic when all the typing constraints contained are atomic.
  	\item[]{\bf Satisfiability} A set is \textit{solved} when all the included constraints can be solved by application of one or
  		more of the sub-typing rules (type constraints) or by transitivity (flag constraints).
  		Following, a set $\mathcal{L}$ is \textit{solvable} if there exists a substitution $\sigma$ that solves $\sigma \mathcal{L}$.
	 	\item[]{\bf Derivation} When the validity of a set $\mathcal{L}$ can be deduced from another set $\mathcal{L'}$ by application of
		  the sub-typing rules and the transitivity, we say that $\mathcal{L}$ \textit{derives} from $\mathcal{L'}$,
		  written $\mathcal{L'} \vdash \mathcal{L}$.
  \end{itemize}
\end{defn}

\begin{defn}{\bf Typing rules} A typing judgement is a sequent of the form $\Gamma \vdash_\mathcal{L} t : T$, holding the
	meaning \textit{Under the condition that $\mathcal{L}$ is solvable, the judgement $\Gamma \vdash t : T$ holds}.
	A sequent is \textit{valid} if a typing derivation can be constructed using the typing rules of LL'.
  In the typing rules, we use the notation $!^I \Gamma$ to designate contexts of the form 
  $!^I \Gamma = x_1 : \,!^{i_1}A_1 \dots x_n : \,!^{i_n}A_n$ and $I = \{i_1 \dots i_n\}$. \\

	\begin{prooftree}
		\AxiomC{}
		\RightLabel{$(ax)$}
			\UnaryInfC{$!^I \Gamma, x : T \vdash_{\{T <: U\} \cup \{1 \le I \}} x : U$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$!^I\Gamma, x : T \vdash_{\mathcal{L}} t : U$}
		\RightLabel{$(\lambda)$}
		\UnaryInfC{$!^I\Gamma \vdash_{\mathcal{L} \cup \{n \le I\} } \lambda x.t : ~ !^n(T \multimap U)$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma_1, !^I\Delta \vdash_{\mathcal{L}} t : \, !^n(T \multimap U)$}
		\AxiomC{$\Gamma_2, !^I\Delta \vdash_{\mathcal{L'}} u : T$}
		\RightLabel{$(app)$}
		\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_{\mathcal{L \cup L'} \cup \{1 \le I\} } t u : U$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma_1, !^I\Delta \vdash_{\mathcal{L}} t : \, !^n A$}
		\AxiomC{$\Gamma_2, !^I\Delta \vdash_{\mathcal{L'}} u : \, !^m B$}
		\RightLabel{$(\otimes.I)$}
		\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_{\mathcal{L \cup L'} \cup \{1 \le I, \, p \le n, \, p \le m \} }
			\pair{t}{u}:\, !^p(\,!^nA \otimes !^mB)$}
	\end{prooftree}
	\begin{prooftree}
		\AxiomC{$\Gamma_1, !^I\Delta \vdash_\mathcal{L} t : \, !^p (!^nA \otimes \,!^mB)$}
		\AxiomC{$\Gamma_2, !^I\Delta, x : \,!^nA, y : \,!^mB \vdash_\mathcal{L'} u : V$}
		\RightLabel{$(\otimes.E)$}
		\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_{\mathcal{L \cup L'} \cup \{ 1 \le I, p \le n, p \le m \} }
			\, \text{let} \pair{x}{y} = t ~ \text{in} ~ u \, : V$}
	\end{prooftree}
\end{defn}

\subsection{Soundness and completeness of LL'}

\begin{defn} We equip ourselves with is a translation $\tau$ from LL types to LL', defined as follow :
  \begin{center}
	\begin{tabular}{ll}
	  $\tau (!^n \alpha) ~=~ !^1 \alpha$ &	$\tau \alpha ~=~ !^0 \alpha$ \\
		$\tau(!^n (T \multimap U)) ~=~ \, !^1(\tau T \multimap \tau U)$ & 	$\tau(T \multimap U) ~=~ !^0(\tau T \multimap \tau U)$ \\
		$\tau(!^n(T \otimes U)) ~=~ !^1 (\tau (! T) \, \otimes \, \tau(! U))$ & $\tau(T \otimes U) ~=~ !^0 (\tau T \otimes \tau U)$
	\end{tabular}
	\end{center}
	where $n > 0$.
	The definition of $\tau$ ensures that the return value of $\tau$ is always a LL' type.
\end{defn}

\begin{lemma} Let $T, U$ be LL types, the following propositions are equivalent :
  \label{subtype-eq}
	\begin{center}
	\begin{tabular}{ll}
		$(a)$ & $\tau T <: \tau U$ \\
		$(b)$ & $\tau (\bang T) <: \tau U$ \\
		$(c)$ & $\tau (\bang T) <: \tau (\bang U)$
	\end{tabular}
	\end{center}
	
	\begin{proof} By induction on the size of $T$ and $U$, which size is be given by the number
		of free type variables. It can be showed that if any of the above proposition is satisfied, $T$ and $U$ must have
		the same size.
	\end{proof}
\end{lemma}

\begin{lemma}
	\label{subLL=>subLL'}
	Let $T, U$ be LL types. If $T <: U$ then $\tau T <: \tau U$.

	\begin{proof}
		By induction on the sub-typing derivation :
		\begin{itemize}
			\item If the rule is $(var)$, $T = U = \alpha$. By reflexivity of the sub-typing relation $<:$ in LL', $\tau \alpha <: \tau \alpha$.
			
			\item If the rule is $(\multimap)$ or $(\otimes)$. By induction on $T' <: T$ and $U <: U'$, we have $\tau T' <: \tau T$ and
				$\tau U <: \tau U'$. Hence, by application of the rule $(\multimap)$ (resp. $(\otimes)$) of LL',
				$\tau T \multimap \tau U <: \tau T' \multimap \tau U$ (resp. $\tau T \otimes \tau U <: \tau T' \otimes \tau U$).			
				
			\item If the rule is $(!)$. If $A$ and $B$ are both type variables, or linear implications, the induction is easily proved.
				However, it is not the case with $A = T_A \otimes U_A$, and $B = T_B \otimes U_B$.
				The induction hypothesis, and the rule $(\otimes)$ of LL' give the relations $\tau T_A <: \tau T_B$ and $\tau U_A <: \tau U_B$.
				
				Depending on the respective value of $n, m$, three cases present themselves.
				The first case, with $n = m = 0$, can be eliminated as being trivial.
				If $n > 0$ and $m = 0$,
					\begin{center}
					\begin{tabular}{c}
					$\tau (!^n A) = ~ !^1 (\tau (\bang T_A) \otimes \tau (\bang U_A))$ \\
					$\tau (!^m B) = ~ !^0 (\tau T_B \otimes \tau U_B)$					
					\end{tabular}
					\end{center}
				From the lemma \ref{subtype-eq} and the induction hypothesis, it follows that $\tau (\bang T_A) <: \tau T_B$ and
				$\tau (\bang U_A) <: \tau U_B$. Thence, by application of the rule $(\otimes)$ of LL',
					$$ \tau (\bang T_A) \otimes \tau (\bang U_A) ~ <: ~ \tau T_B \otimes U_B$$
				Consequently, by application of the rule $(!)$,
					$$ !^1 (\tau (\bang T_A) \otimes \tau (\bang U_A)) ~ <: ~ !^0 (\tau T_B \otimes U_B)$$
				which is the same as $\tau (!^nA) <: \tau (!^mB)$.
				The last case, where $n, m > 0$, is proved using the same method.

		\end{itemize}
	\end{proof}
\end{lemma}
	
\begin{prop}
	\label{LL=>LL'}
	Let $t$ be a term, and $\Pi$ a typing derivation of the typing judgement
	$\Gamma \vdash t : T$ :
	\begin{prooftree}
		\AxiomC{$\Pi$}
		\UnaryInfC{$\Gamma \vdash t : T$}
	\end{prooftree}
	Then there exists a solved set $\mathcal{L}$ such that the following typing derivation holds :
	\begin{prooftree}
		\AxiomC{$\tau\Pi$}
		\UnaryInfC{$\tau\Gamma \vdash_\mathcal{L} t : \tau T$}
	\end{prooftree}
	
	\begin{proof}
		By induction on the typing derivation of $t$ : if the last typing rule used is
			\begin{itemize}
				\item{$(ax)$} The typing derivation
			    \begin{prooftree}
						\AxiomC{$T <: U$}
						\RightLabel{$(ax)$}
						\UnaryInfC{$! \Delta, x : T \vdash x : U$}
					\end{prooftree}
					is transformed by application of $\tau$ into
					\begin{prooftree}
						\AxiomC{$\tau T <: \tau U$}
						\RightLabel{$(ax)$}
						\UnaryInfC{$!^I \tau\Delta, x : \tau T \vdash x : \tau U$}
					\end{prooftree}
					with $I = 1 \dots 1$.
					Using the constraint set $\mathcal{L} = \{ \tau T <: \tau U \} \cup \{ 1 \le I \}$,
					the typing derivation becomes valid in LL'. We now need to show that $\mathcal{L}$ is satisfied.
					Since $T <: U$, by application of the lemma, the sub-typing constraint $\tau T <: \tau U$ is satisfied.
					The constraints of $\{ 1 \le I \}$ are all trivially satisfied.
					
				\item{$(\lambda_1)$} The typing derivation
					\begin{prooftree}
						\AxiomC{$\Pi$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma, x : T \vdash t : U$}
						\RightLabel{$(\lambda_1)$}
						\UnaryInfC{$\Gamma \vdash \lambda x.t : T \multimap U$}
					\end{prooftree}
					is transformed by application of $\tau$ into
					\begin{prooftree}
						\AxiomC{$\tau\Pi$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$!^I \tau\Gamma, x : \tau T \vdash t : \tau U$}
						\RightLabel{$(\lambda_1)$}
						\UnaryInfC{$!^I \tau \Gamma \vdash \lambda x.t : ~ !^0(\tau T \multimap \tau U)$}
					\end{prooftree}
					
					The induction hypothesis applied to the typing derivation $\Pi$ produces a solved constraint set
					$\mathcal{L}$ such that $!^I \tau\Gamma, x : \tau T \vdash_\mathcal{L} t : \tau U$ is valid.
					We now apply the typing rule $(\lambda)$ of LL' with the annotation $n = 0$. The typing judgement
					$!^I \tau\Gamma \vdash_{\mathcal{L} \cup \{ 0 \le I \}} \lambda x.t : ~ !^0 (\tau T \multimap \tau U)$ is valid,
					and since for all flag $n$, $0 \le n \le 1$, the constraints $\{ 0 \le I \}$ are all satisfied.
					
				\item{$(\lambda_2)$} The typing derivation
					\begin{prooftree}
						\AxiomC{$\Pi$}
						\noLine
						\UnaryInfC{$\vdots$}
						\noLine
						\UnaryInfC{$!\Gamma, x : T \vdash t : U$}
						\RightLabel{$(\lambda_1)$}
						\UnaryInfC{$!\Gamma \vdash \lambda x.t : ~ !(T \multimap U)$}
					\end{prooftree}
					is transformed by application of $\tau$ into
					\begin{prooftree}
						\AxiomC{$\tau\Pi$}
						\noLine
						\UnaryInfC{$\vdots$}
						\noLine
						\UnaryInfC{$!^I \tau\Gamma, x : \tau T \vdash t : \tau U$}
						\RightLabel{$(\lambda_1)$}
						\UnaryInfC{$!^I \tau \Gamma \vdash \lambda x.t : ~ !^1 ( \tau T \multimap \tau U)$}
					\end{prooftree}
					with $I = 1 \dots 1$.
					The induction hypothesis applied to the typing derivation $\Pi$ produces a solved constraint set
					$\mathcal{L}$ such that $!^I \tau\Gamma, x : \tau T \vdash_\mathcal{L} t : \tau U$ is valid.
					We now apply the typing rule $(\lambda)$ of LL' with the annotation $n = 1$. The typing judgement
					$!^I \tau\Gamma \vdash_{\mathcal{L} \cup \{ 1 \le I \}} \lambda x.t : ~ !^1 (\tau T \multimap \tau U)$ is valid.
					Since $I = 1 \dots 1$, all the constraints in $\{ 1 \le I \}$ are satisfied.
					
				\item{$(app)$} The typing derivation
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_1, !\Delta \vdash t : T \multimap U$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_2, !\Delta \vdash u : T$}
						\RightLabel{$(app)$}
						\BinaryInfC{$\Gamma_1, \Gamma_2, !\Delta \vdash t u : U$}
					\end{prooftree}
					is transformed by application of $\tau$ into
					\begin{prooftree}
						\AxiomC{$\tau\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_1, !^I\tau\Delta \vdash t : \tau T \multimap \tau U$}
						\AxiomC{$\tau\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_2, !^I\tau\Delta \vdash u : \tau T$}
						\RightLabel{$(app)$}
						\BinaryInfC{$\tau\Gamma_1, \tau\Gamma_2, !^I\tau\Delta \vdash t u : \tau U$}
					\end{prooftree}
					with $I = 1 \dots 1$.
					The induction hypothesis applied to the typing derivations $\Pi_1$ and $\Pi_2$ produces
					two solved constraint sets $\mathcal{L}$ and $\mathcal{L'}$ such that
					$\tau\Gamma_1, !^I \tau\Delta \vdash_\mathcal{L} t : \tau T \multimap \tau U$ and
					$\tau\Gamma_2, !^I \tau\Delta \vdash_\mathcal{L'} u : \tau T$ are valid.
					Using the constraint set $\mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I \}$, by application of the typing rule $(app)$ of LL',
					the typing judgement $\tau\Gamma_1, \tau\Gamma_2, !^I \tau\Delta \vdash_\mathcal{L''} t u : \tau U$ is valid.
					Now, since $I = 1 \dots 1$, all the constraints in $\{ 1 \le I \}$ are satisfied.
					
				\item{$(\otimes.I)$} The typing derivation
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_1, !\Delta \vdash t :\, !^nT$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_2, !\Delta \vdash u :\, !^nU$}
						\RightLabel{$(\otimes.I)$}
						\BinaryInfC{$\Gamma_1, \Gamma_2, !\Delta \vdash \pair{t}{u} : \, !^n(T \otimes U)$}
					\end{prooftree}
					Two cases now may occur, whether $n$ is zero or not.
					If $n = 0$, then the derivation is transformed by application of $\tau$ into
					\begin{prooftree}
						\AxiomC{$\tau\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_1, !^I\tau\Delta \vdash t : \tau T$}
						\AxiomC{$\tau\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_2, !^I\tau\Delta \vdash u : \tau U$}
						\RightLabel{$(\otimes.I)$}
						\BinaryInfC{$\tau\Gamma_1, \tau\Gamma_2, !^I\tau\Delta \vdash \pair{t}{u} : \, !^0 (\tau T \otimes \tau U))$}
					\end{prooftree}
					with $I = 1 \dots 1$.
					The induction hypothesis applied to the typing derivations $\Pi_1$ and $\Pi_2$ produces
					two solved constraint sets $\mathcal{L}$ and $\mathcal{L'}$ such that
					$\tau\Gamma_1, !^I \tau\Delta \vdash_\mathcal{L} t : \tau T$ and
					$\tau\Gamma_2, !^I \tau\Delta \vdash_\mathcal{L'} u : \tau U$ are valid. Let us write $\tau T = \, !^p T'$ and
					$\tau U = \, !^q U'$. Using the constraint set
						$$ \mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I, 0 \le p, 0 \le q \}$$
					by application of the typing rule $(\otimes.I)$ of LL', the typing judgement
					$\tau\Gamma_1, \tau\Gamma_2, !^I \tau\Delta \vdash_\mathcal{L''} t u : \tau U$ is valid.
					The constraints of $\mathcal{L''}$ are all satisfied.
					
					
					If $n > 0$, then the derivation is transformed by application of $\tau$ into
					\begin{prooftree}
						\AxiomC{$\tau\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_1, !^I\tau\Delta \vdash t : \tau (!^nT)$}
						\AxiomC{$\tau\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_2, !^I\tau\Delta \vdash u : \tau (!^nU)$}
						\RightLabel{$(\otimes.I)$}
						\BinaryInfC{$\tau\Gamma_1, \tau\Gamma_2, !^I\tau\Delta \vdash \pair{t}{u} : \, !^1 (\tau (\bang T) \otimes \tau (\bang U))$}
					\end{prooftree}
					with $I = 1 \dots 1$.
					The application of $\tau$ to $\bang T$ and $\bang U$ will yield $!^1 T'$ and $!^1 U'$. The induction
					hypothesis applied applied to the typing derivations $\Pi_1$ and $\Pi_2$ produces
					two solved constraint sets $\mathcal{L}$ and $\mathcal{L'}$. Using the constraint set
						$$ \mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I, 1 \le 1, 1 \le 1 \}$$
					by application of the typing rule $(\otimes.I)$ of LL', the typing judgement
					$\tau\Gamma_1, \tau\Gamma_2, !^I \tau\Delta \vdash_\mathcal{L''} t u : \tau U$ is valid, and all the constraints of
					$\mathcal{L''}$ are satisfied.
					
				\item{$(\otimes.E)$} The typing derivation
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_1, !\Delta \vdash t : \, !^n(T \otimes U)$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_2, !\Delta, x : \, !^nT, y : \, !^nU \vdash u : V$}
						\RightLabel{$(\otimes.E)$}
						\BinaryInfC{$\Gamma_1, \Gamma_2, !\Delta \vdash \text{let} ~\pair{x}{y} = t ~\text{in}~ u : V$}
					\end{prooftree}
					is transformed by application of $\tau$ into
					\begin{center}
					\footnotesize
					\begin{prooftree}
						\AxiomC{$\tau\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_1, !^I\tau\Delta \vdash t : \,!^p (\tau (!^nT) \otimes \tau (!^nU))$}
						\AxiomC{$\tau\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\tau\Gamma_2, !^I\tau\Delta, x : \, \tau(!^nT), y : \, \tau(!^nU) \vdash u : \tau V$}
						\RightLabel{$(\otimes.E)$}
						\BinaryInfC{$\tau\Gamma_1, \tau\Gamma_2, !^I\tau\Delta \vdash \text{let} ~\pair{x}{y} = t ~\text{in}~ u : \tau V$}
					\end{prooftree}
					\end{center}
					with $I = 1 \dots 1$, and $p = 1$ if $n > 0$ and else $0$.
					The induction hypothesis applied applied to the typing derivations $\Pi_1$ and $\Pi_2$ produces
					two solved constraint sets $\mathcal{L}$ and $\mathcal{L'}$, such that the typing judgements
  					 $$\tau\Gamma_1, !^I \tau\Delta \vdash_\mathcal{L} t : \,!^p (\tau (!^nT) \otimes \tau (!^nU))$$
	  				 $$\tau\Gamma_2, !^I \tau\Delta, x : \, \tau(!^nT), y : \, \tau(!^nU) \vdash_\mathcal{L'} u : \tau V$$
					are valid. Supposing $\tau (!^n T) = \, !^{n'}T'$ and $\tau (!^n U) = \,!^{m'}U'$, using the constraint set
						$$ \mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I, p \le m', p \le n' \}$$
					by application of the typing rule $(\otimes.E)$ of LL', the typing judgement
					$\tau\Gamma_1, \tau\Gamma_2, !^I \tau\Delta \vdash_\mathcal{L''} \text{let} ~\pair{x}{y} = t ~\text{in}~ u : \tau V$
				  is valid, and all the constraints of $\mathcal{L''}$ are satisfied.
					
			\end{itemize}	
	\end{proof}
\end{prop}

\begin{defn} Again we define a translation $\rho$ from LL' types to LL.
	In the definition, it is assumed that all the annotation flags are $0$ or $1$.
  \begin{center}
	\begin{tabular}{ll}
		$\rho (!^0 \alpha) = \alpha $ & $\rho (!^1 \alpha) = \bang \alpha$ \\
		$\rho (!^0 (T \multimap U)) ~=~ \rho T \multimap \rho U$ & $\rho (!^1(T \multimap U)) ~=~ \bang (\rho T \multimap \rho U)$ \\
		$\rho (!^0 (T \otimes U)) ~=~ \rho T \otimes \rho U$ & $\rho (!^1(T \otimes U)) ~=~ \bang (\rho T \otimes \rho U)$ 
	\end{tabular}
	\end{center}
\end{defn}

\begin{lemma}
	\label{subLL'=>subLL}
	Let $T$ and $U$ be LL' types. If $T <: U$, then $\rho T <: \rho U$.
\end{lemma}

\begin{prop}
	\label{LL'=>LL}
	Let $t$ be a term, $\mathcal{L}$ a solvable set of constraints and $\Pi$ a typing derivation of the typing judgement
	$\Gamma \vdash_\mathcal{L} t : T$ is valid :
	\begin{prooftree}
		\AxiomC{$\Pi$}
		\UnaryInfC{$\Gamma \vdash_\mathcal{L} t : T$}
	\end{prooftree}
	Then for any complete substitution $\sigma$ solution of $\mathcal{L}$, the following typing derivation holds :
	\begin{prooftree}
		\AxiomC{$(\rho \circ \sigma) \Pi$}
		\UnaryInfC{$(\rho \circ \sigma) \Gamma \vdash t : (\rho \circ \sigma) T$}
	\end{prooftree}
	
	\begin{proof}
		The proposition is proved by induction on the typing derivation. In all the cases, $\sigma$ is any substitution solution
		of the constraint set of the conclusion sequent. The notation $\rho_\sigma$ will be used as a shortcut for $\rho \circ \sigma$.
		If the last typing rule used is
			\begin{itemize}
				\item{$(ax)$} The typing derivation is
					\begin{prooftree}
						\AxiomC{}
						\RightLabel{$(ax)$}
						\UnaryInfC{$!^I \Delta, x : T \vdash_\mathcal{L} x : U$}
					\end{prooftree}
					with $\mathcal{L} = \{ T <: U \} \cup \{ 1 \le I \}$. By hypothesis, $\sigma T <: \sigma U$ is satisfied, and $\sigma I = 1 \dots 1$.
					Moreover, the lemma \ref{subLL'=>subLL} ensures that $\rho_\sigma T <: \rho_\sigma U$.
					Consequently, by application of $\rho_\sigma$, the above typing derivation is transformed into :
					\begin{prooftree}
						\AxiomC{$\rho_\sigma T <: \rho_\sigma U$}
						\RightLabel{$(ax)$}
						\UnaryInfC{$! \rho_\sigma \Delta, x : \rho_\sigma T \vdash x : \rho_\sigma U$}
					\end{prooftree}
					Since the constraint $\rho_\sigma T <: \rho_\sigma U$ is satisfied, the typing derivation is valid in LL.
					
				\item{$(\lambda)$} The typing derivation is
					\begin{prooftree}
						\AxiomC{$\Pi$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$!^I \Gamma, x : T \vdash_\mathcal{L} t : U$}
						\RightLabel{$(\lambda)$}
						\UnaryInfC{$!^I \Gamma \vdash_\mathcal{L'} \lambda x.t : ~ !^n(T \multimap U)$}
					\end{prooftree}
					with $\mathcal{L'} = \mathcal{L} \cup \{ n \le I \}$. \\
					$\sigma$ being a solution to $\mathcal{L'}$, is also a solution to $\mathcal{L}$.
					The induction hypothesis is applicable, and $\rho_\sigma \Gamma, x : \rho_\sigma T \vdash t : \rho_\sigma U$ is a valid
					typing judgement in LL. \\
					The term $\sigma(n)$ can have the value $0$ or $1$ :\\
						\begin{itemize}
							\item If the value is $0$, then we can apply the typing rule $(\lambda_1)$, and
								\begin{prooftree}
									\AxiomC{$\rho_\sigma\Pi$}
									\noLine
									\UnaryInfC{$\vdots$}
									\noLine
									\UnaryInfC{$\rho_\sigma\Gamma, x : \rho_\sigma T \vdash t : \rho_\sigma U$}
									\RightLabel{$(\lambda_1)$}
									\UnaryInfC{$\rho_\sigma \Gamma \vdash \lambda x.t : ~ \rho_\sigma T \multimap \rho_\sigma U$}
								\end{prooftree}
								is a valid typing derivation in LL.
							\item If the value is $1$, since $\sigma$ satisfies $\mathcal{L'}$, and especially $\{ 1 \le I \}$,
							$\sigma I = 1 \dots 1$. Then we can apply the typing rule $(\lambda_2)$, and
								\begin{prooftree}
									\AxiomC{$\rho_\sigma\Pi$}
									\noLine
									\UnaryInfC{$\vdots$}
									\noLine
									\UnaryInfC{$!\rho_\sigma\Gamma, x : \rho_\sigma T \vdash t : \rho_\sigma U$}
									\RightLabel{$(\lambda_1)$}
									\UnaryInfC{$!\rho_\sigma \Gamma \vdash \lambda x.t : ~ \bang (\rho_\sigma T \multimap \rho_\sigma U)$}
								\end{prooftree}
								is a valid typing derivation in LL.
						\end{itemize}
						
				\item{$(app)$} The typing derivation is
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_1, !^I\Delta \vdash_\mathcal{L} t : T \multimap U$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_2, !^I\Delta \vdash_\mathcal{L'} u : T$}
						\RightLabel{$(app)$}
						\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_\mathcal{L''} t u : U$}
					\end{prooftree}
					with $\mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I \}$. \\
					Since $\sigma$ is a solution to $\mathcal{L''}$, it is also a solution to $\mathcal{L}$ and $\mathcal{L'}$,
					and $\sigma I = 1 \dots 1$.
					
					By induction on $\Pi_1$ and $\Pi_2$, both typing judgements
						$$\rho_\sigma \Gamma_1, !\rho_\sigma \Delta \vdash t : \rho_\sigma T \multimap \rho_\sigma U$$
					and
						$$\rho_\sigma \Gamma_2, !\rho_\sigma \Delta \vdash u : \rho_\sigma T$$
					are valid in LL.
					Thus, by application of the typing rule $(app)$ of LL we get that
						\begin{prooftree}
							\AxiomC{$\rho_\sigma\Pi_1$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_1, !\rho_\sigma\Delta \vdash t : \rho_\sigma T \multimap \rho_\sigma U$}
							\AxiomC{$\rho_\sigma\Pi_2$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_2, !\rho_\sigma\Delta \vdash u : \rho_\sigma T$}
							\RightLabel{$(app)$}
							\BinaryInfC{$\rho_\sigma\Gamma_1, \rho_\sigma\Gamma_2, !\rho_\sigma\Delta \vdash t u : \rho_\sigma U$}
						\end{prooftree}
					is a valid typing derivation in LL.
					
				\item{$(\otimes.I)$} The typing derivation is
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_1, !^I\Delta \vdash_\mathcal{L} t : \, !^nA$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_2, !^I\Delta \vdash_\mathcal{L'} u : \, !^mB$}
						\RightLabel{$(\otimes.I)$}
						\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_\mathcal{L''} \pair{t}{u} : \, !^p(!^n A \otimes !^m B)$}
					\end{prooftree}
					with $\mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I \} \cup \{ p \le n, p \le m \}$. \\
					Since $\sigma$ is a solution to $\mathcal{L''}$, it is also a solution to $\mathcal{L}$ and $\mathcal{L'}$,
					and verifies $\sigma I = 1 \dots 1$, $\sigma(p) \le \sigma(n)$, $\sigma(p) \le \sigma(m)$.
					
					By induction on $\Pi_1$ and $\Pi_2$, both typing judgements
						$$\rho_\sigma \Gamma_1, !\rho_\sigma \Delta \vdash t : \rho_\sigma(!^n A)$$
						$$\rho_\sigma \Gamma_2, !\rho_\sigma \Delta \vdash u : \rho_\sigma(!^m B)$$
					are valid in LL.
					Depending on the value of $\sigma (p)$ : \\
					If $\sigma (p) = 1$, then due to the constraints $\sigma (n) = \sigma(m) = 1$ as well.
					By definition of $\rho$, $\rho_\sigma (!^nT) = \,\bang \rho_\sigma T$, $\rho_\sigma(!^mU) = \, \bang \rho_\sigma U$ and
						$$\rho_\sigma (!^p(!^n T \otimes !^m U)) = \,\bang (\bang \rho_\sigma T \otimes \,\bang \rho_\sigma U)$$
					Thus, by application of the typing rule $(\otimes.I)$ of LL we get that
						\begin{prooftree}
							\AxiomC{$\rho_\sigma\Pi_1$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_1, !\rho_\sigma\Delta \vdash t : \,\bang\bang \rho_\sigma T$}
							\AxiomC{$\rho_\sigma\Pi_2$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_2, !\rho_\sigma\Delta \vdash u : \,\bang\bang \rho_\sigma U$}
							\RightLabel{$(app)$}
							\BinaryInfC{$\rho_\sigma\Gamma_1, \rho_\sigma\Gamma_2, !\rho_\sigma\Delta \vdash
								\pair{t}{u} : \,\bang (\bang \rho_\sigma T \otimes \,\bang \rho_\sigma U)$}
						\end{prooftree}
					is a valid typing derivation in LL (on the condition that there exists an isomorphism $\bang\bang T \equiv \bang T$).
					If $\sigma (p) = 0$, no condition restricts $\sigma (n)$ and $\sigma(m)$.
					By application of the typing rule $(\otimes.I)$ of LL we get that
						\begin{prooftree}
							\AxiomC{$\rho_\sigma\Pi_1$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_1, !\rho_\sigma\Delta \vdash t : \rho_\sigma (!^nT)$}
							\AxiomC{$\rho_\sigma\Pi_2$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_2, !\rho_\sigma\Delta \vdash u : \rho_\sigma (!^mU)$}
							\RightLabel{$(app)$}
							\BinaryInfC{$\rho_\sigma\Gamma_1, \rho_\sigma\Gamma_2, !\rho_\sigma\Delta \vdash
								\pair{t}{u} : \rho_\sigma (!^nT) \otimes \rho_\sigma (!^mU)$}
						\end{prooftree}
					is a valid typing derivation in LL.
					
				\item{$(\otimes.E)$} The typing derivation
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_1, !^I\Delta \vdash_\mathcal{L} t : \, !^p(!^nT \otimes !^mU)$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\vdots$} \noLine
						\UnaryInfC{$\Gamma_2, !^I\Delta, x : \, !^nT, y : \, !^mU \vdash_\mathcal{L'} u : V$}
						\RightLabel{$(\otimes.E)$}
						\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_\mathcal{L''} \text{let} ~\pair{x}{y} = t ~\text{in}~ u : V$}
					\end{prooftree}
					with $\mathcal{L''} = \mathcal{L \cup L'} \cup \{ 1 \le I, p \le n, p \le m \}$.
					$\sigma$ being a solution of $\mathcal{L''}$ satisfies $\mathcal{L}$ and $\mathcal{L'}$ as well, and $\sigma I = 1 \dots 1$.
					The induction hypothesis applied to $\Pi_1$ and $\Pi_2$ assures that the typing judgements
						\begin{center}
						\begin{tabular}{c}
							$\rho_\sigma \Gamma_1, \,\bang \rho_\sigma \Delta \vdash t : \rho_\sigma (!^p(!^nT \otimes !^mU))$ \\
							$\rho_\sigma \Gamma_2, \,\bang \rho_\sigma \Delta, x : \rho_\sigma (!^nT), y : \rho_\sigma(!^mU)
								 \vdash u : \rho_\sigma V$
						\end{tabular}
						\end{center}				
					are valid in LL.
					If $\sigma (p) = 1$, then
						\begin{center}
						\begin{tabular}{l}
							$\rho_\sigma (!^nT) = \,\bang \rho_\sigma T$ \\
							$\rho_\sigma (!^mU) = \,\bang \rho_\sigma U$ \\
							$\rho_\sigma (!^p(!^nT \otimes !^mU)) = \,\bang (\bang \rho_\sigma T \otimes \,\bang \rho_\sigma U)$
						\end{tabular}
						\end{center}
					The typing rule $(\otimes.E)$ of LL can be applied to $\rho_\sigma \Pi_1$ and $\rho_\sigma \Pi_2$, yielding the
					derivation
						\begin{center}
						\footnotesize
						\begin{prooftree}
							\AxiomC{$\rho_\sigma \Pi_1$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma \Gamma_1, \bang\rho_\sigma \Delta \vdash t : \bang(\bang \rho_\sigma T \otimes \bang \rho_\sigma U)$}
							\AxiomC{$\rho_\sigma \Pi_2$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_2, !\rho_\sigma\Delta, x : \bang\bang \rho_\sigma T, y : \bang\bang \rho_\sigma U \vdash
								u : \rho_\sigma V$}
							\RightLabel{$(\otimes.E)$}
							\BinaryInfC{$\rho_\sigma \Gamma_1, \rho_\sigma \Gamma_2, ! \rho_\sigma \Delta \vdash
								\text{let} ~\pair{x}{y} = t ~\text{in}~ u : \rho_\sigma V$}
						\end{prooftree}
						\end{center}
					provided that $\bang \bang T \equiv \bang T$.
					If $\sigma (p) = 0$, then the following derivation is valid
						\begin{center}
						\footnotesize
						\begin{prooftree}
							\AxiomC{$\rho_\sigma \Pi_1$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma \Gamma_1, \bang\rho_\sigma \Delta \vdash t : \rho_\sigma (!^nT) \otimes \rho_\sigma (!^mU)$}
							\AxiomC{$\rho_\sigma \Pi_2$} \noLine
							\UnaryInfC{$\vdots$} \noLine
							\UnaryInfC{$\rho_\sigma\Gamma_2, !\rho_\sigma\Delta, x : \rho_\sigma (!^nT), y : \rho_\sigma (!^mU) \vdash
								u : \rho_\sigma V$}
							\RightLabel{$(\otimes.E)$}
							\BinaryInfC{$\rho_\sigma \Gamma_1, \rho_\sigma \Gamma_2, ! \rho_\sigma \Delta \vdash
								\text{let} ~\pair{x}{y} = t ~\text{in}~ u : \rho_\sigma V$}
						\end{prooftree}
						\end{center}
					In any case, the typing judgement
						$$ \rho_\sigma \Gamma_1, \rho_\sigma \Gamma_2, ! \rho_\sigma \Delta \vdash
								\text{let} ~\pair{x}{y} = t ~\text{in}~ u : \rho_\sigma V $$
					has a valid typing derivation in LL.
					
			\end{itemize}
	\end{proof}
\end{prop}
	
\begin{thm}{\bf Soundness and completeness}
	\label{soundness}
 	\it Let $t$ be a term, and $\Gamma$ a typing context in LL. $t$ can be typed
	in the context $\Gamma$ in LL if and 	only if $t$ that can be typed in the context $\tau\Gamma$ in LL'.
	\begin{proof} By application of the propositions \ref{LL=>LL'} and \ref{LL'=>LL}.
	\end{proof}
\end{thm}	
	
\section{Constraint typing}

\subsection{Algorithm}

	This is the first part of the type inference algorithm.
	The algorithm takes an incomplete typing judgement of the form :
		$$x_1 : T_1 \dots x_n : T_n ~ \vdash ~ M : T$$
	and outputs a set of linear constraints $\mathcal{L}$ such that the typing judgement
	  $$x_1 : T_1 \dots x_n : T_n ~ \vdash_{\mathcal{L}} ~ M : T$$
	is valid. The algorithm never fails to provide such set, the unification algorithm will tell if this
	set is solvable, and so if the term can be typed.
	The notation $\Gamma|_t$ is used to represent $\Gamma|_{FV(t)}$.
	
	The algorithm proceeds as follow :
	\begin{itemize}
		\item $\text{ConstraintTyping} ~ (~ !^I \Delta, x : T \vdash x : U ~) = $ \\
		  \begin{tabular}{l}
				output $\{ T <: U \} \cup \{ 1 \le I \}$
		  \end{tabular}
		  
		\item $\text{ConstraintTyping} ~ (~ \Gamma \vdash t u : T ~) = $ \\
			\begin{tabular}{l}
				let $\alpha$ be a fresh type variable, and $n$ a fresh flag \\
				let $\mathcal{L} = ~ \text{ConstraintTyping} ~ (~ \Gamma|_t \vdash t : \, !^n\alpha \multimap T ~)$ \\
				let $\mathcal{L'} = ~ \text{ConstraintTyping} ~ ( ~ \Gamma|_u \vdash u : \, !^n\alpha ~)$ \\
				let $!^I\Delta = \Gamma ~ \backslash ~ (FV(t) \oplus FV(u))$ \\
				output $\mathcal{L \cup L'} \cup \{ 1 \le I \}$
			\end{tabular}
			
		\item $\text{ConstraintTyping} ~ (~ !^I \Gamma \vdash \lambda x.t : T ~) = $ \\
			\begin{tabular}{l}
				let $\alpha$ and $\beta$ be fresh type variables \\
				let $n$, $m$ and $p$ be fresh flags \\
				let $\mathcal{L} = ~ \text{ConstraintTyping} ~ ( \, !^I \Gamma, ~ x : \, !^m \alpha \vdash  t : \, !^n\beta)$ \\
				output $\mathcal{L} \cup \{ p \le I \} \cup \{ \, !^p (!^m \alpha \multimap \, !^n \beta) <: T\}$
			\end{tabular}
			
		\item $\text{ConstraintTyping} ~ (~ \Gamma \vdash \pair{t}{u} : T ~) = $ \\
			\begin{tabular}{l}
				let $\alpha$ and $\beta$ be fresh type variables \\
				let $n$, $m$ and $p$ be fresh flags \\
				let $\mathcal{L} = ~ \text{ConstraintTyping} ~ ( \, \Gamma|_t \vdash t : \, !^n\alpha)$ \\
				let $\mathcal{L'} = ~ \text{ConstraintTyping} ~ ( \, \Gamma|_u \vdash u : \, !^m\beta)$ \\
				let $!^I\Delta = \Gamma ~ \backslash ~ (FV(t) \oplus FV(u))$ \\
				output $\mathcal{L \cup L'} \cup \{ 1 \le I, p \le n, p \le m \} \cup \{ \, !^p (!^n \alpha \otimes \, !^m \beta) <: T\}$
			\end{tabular}
			
		\item $\text{ConstraintTyping} ~ (~ \Gamma \vdash ~\text{let}~ \pair{x}{y} = t ~\text{in}~ u : T ~) = $ \\
			\begin{tabular}{l}
				let $\alpha$ and $\beta$ be fresh type variables \\
				let $n$, $m$ and $p$ be fresh flags \\
				let $\mathcal{L} = ~ \text{ConstraintTyping} ~ ( \, \Gamma|_t \vdash t : \, !^p(!^n \alpha \otimes !^m \beta)$ \\
				let $\mathcal{L'} = ~ \text{ConstraintTyping} ~ ( \, \Gamma|_u, x : \,!^n \alpha, y : \,!^m \beta \vdash u : T)$ \\
				let $!^I\Delta = \Gamma ~ \backslash ~ (FV(t) \oplus FV(u))$ \\
				output $\mathcal{L \cup L'} \cup \{ 1 \le I, p \le n, p \le m \}$
			\end{tabular}
	\end{itemize}
	
\subsection{Correctness}

\begin{lemma}
	\label{tau-context}
	Let $\sigma$ be a substitution. If the output of the constraint typing algorithm applied to $\Gamma \vdash t : T$ is $\mathcal{L}$,
	and the same applied to $\sigma \Gamma \vdash t : \sigma T$ is $\mathcal{L'}$,
	then $\mathcal{L'} = \sigma \mathcal{L}$ up to the renaming of the fresh variables introduced in the construction of $\mathcal{L}$ and
	$\mathcal{L'}$. If we suppose that the variable generation is deterministic, then $\mathcal{L'} = \sigma \mathcal{L}$.
	
	\begin{proof}
		By induction on the function calls to ContraintTyping (induction on the term $t$).
	\end{proof}
\end{lemma}

\begin{lemma}
	\label{red-context}
	Let $\mathcal{L}$ and $\mathcal{L'}$ be the output of the constraint typing algorithm applied respectively to
	$\Gamma \vdash t : T$ and $\Gamma |_t \vdash t : T$. Then, supposing that $\Gamma = \Gamma |_t, !^I \Delta$,
	the following is true :
		$$ \mathcal{L} = \mathcal{L'} \cup \{ 1 \le I \} $$
		
	\begin{proof}
		By induction on the typing derivation.
	\end{proof}
\end{lemma}

\begin{lemma}
	\label{incl-set}
	Let $\Gamma \vdash_\mathcal{L} t : T$ be a valid typing judgement, and $\mathcal{L}' = ~\text{ConstraintTyping} \,(\Gamma \vdash t : T)$.
	Then there exists a substitution $\sigma$ such that
		\begin{center}
		\begin{tabular}{l}
			$| \sigma |$ is composed of variables freshly generated \\
			$\mathcal{L} \vdash \sigma \mathcal{L'}$.
		\end{tabular}
		\end{center}
		
	\begin{proof} By induction on the typing derivation. Since the typing system is deterministic, as well as the constraint
		typing algorithm, the typing derivation matches the calls to ConstraintTyping. If the last typing rule used is
		\begin{itemize}
			\item $(ax)$. The typing rule is
				\begin{prooftree}
					\AxiomC{}
					\RightLabel{$(ax)$}
					\UnaryInfC{$!^I \Gamma, x : T \vdash_\mathcal{L} x : U$}
				\end{prooftree}
				with $\mathcal{L} = \{ T <: U \} \cup \{ 1 \le I \}$. The output of the constraint typing algorithm is exactly the
				set $\mathcal{L}$, and $\mathcal{L} \vdash \mathcal{L}$ trivially holds.
				
			\item $(\lambda)$. The typing rule is
				\begin{prooftree}
						\AxiomC{$!^I \Gamma, x : T \vdash_\mathcal{L} t : U$}
						\RightLabel{$(\lambda)$}
						\UnaryInfC{$!^I \Gamma \vdash_{\mathcal{L} \cup \{ n \le I \}} \lambda x.t : ~ !^n(T \multimap U)$}
					\end{prooftree}
				The algorithm makes a recursive call on $!^I \Gamma, x : \, !^q \alpha \vdash t : \, !^r\beta$, with the result $\mathcal{L'}$.
				Following, the output of the algorithm is
					$$\mathcal{L''} = \mathcal{L'} \cup \{p \le I \} \cup \{\, !^p (\,!^q\alpha \multimap \,!^r\beta) <: \, !^n (T \multimap U) \}$$
					
				Let $\sigma$ be the substitution :
					$$ \sigma = [ !^q \alpha \mapsto T, ~ !^r \beta \mapsto U , ~ p \mapsto n ] $$
				By application of the lemma \ref{tau-context},
					$$ \text{ConstraintTyping} \, (!^I \Gamma, x : T \vdash t : U) = \sigma \mathcal{L'} $$
				The application of the induction hypothesis yields an substitution $\tau$ such that
				$\mathcal{L} \vdash (\tau \circ \sigma) \mathcal{L'}$. Thence,
					$$(\tau \circ \sigma) \mathcal{L''} = (\tau \circ \sigma) \mathcal{L'} \cup \{ n \le I \} \cup
						\{ !^n(T \multimap U) <: \, !^n(T \multimap U) \}$$
				The sub-typing constraint $!^n(T \multimap U) <: \, !^n(T \multimap U)$ can be directly solved by reflexivity. Consequently,
					$$\mathcal{L} \cup \{ 1 \le I \} \vdash (\tau \circ \sigma) \mathcal{L''}$$
				
			\item $(app)$. The typing rule is
				\begin{prooftree}
					\AxiomC{$\Gamma_1, !^I\Delta \vdash_{\mathcal{L}_1} t : T \multimap U$}
					\AxiomC{$\Gamma_2, !^I\Delta \vdash_{\mathcal{L}_2} u : T$}
					\RightLabel{$(app)$}
					\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_\mathcal{L} t u : U$}
				\end{prooftree}
				with $\mathcal{L} = \mathcal{L}_1 \cup \mathcal{L}_2 \cup \{ 1 \le I \}$.
				
				With $\Lambda = \Gamma_1, \Gamma_2, !^I \Delta$, the following properties hold :
					\begin{center}
					\begin{tabular}{cl}
						$(a)$ & $ \Gamma_1, !^I\Delta|_t = \Lambda |_t $ \\
						$(b)$ & $ \Gamma_2, !^I\Delta|_u = \Lambda |_u $	\\
						$(c)$ & $ \Gamma_1, \Gamma_2 = \Lambda |_{FV(t) \oplus FV(u)} $ \\
						$(d)$ & $ !^I \Delta = \Lambda \backslash_{FV(t) \oplus FV(u)} $
					\end{tabular}
					\end{center}
			 	All of those properties serve to show that the division of the typing context used by the algorithm in the case of applications
			 	is legitimate. The constraint typing algorithm inputs the non-separated set $\Lambda$, and makes two recursive calls
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\text{ConstraintTyping} \, (\Lambda |_t \vdash t : \, !^n\alpha \multimap U) = \mathcal{L}_t$ \\
			 			$\text{ConstraintTyping} \, (\Lambda |_u \vdash u : \, !^n\alpha) = \mathcal{L}_u$
			 		\end{tabular}
			 		\end{center}
			 	and returns the set
			 		$$ \mathcal{L'} = \mathcal{L}_t \cup \mathcal{L}_u \cup \{ 1 \le I' \} $$
			 	where $!^{I'} \Delta = \Lambda \backslash_{FV(t) \oplus FV(u)}$.
			 	The property $(d)$ ensures that $I = I'$, and the properties $(a)$ and $(b)$ show that
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\mathcal{L}_t = \text{ConstraintTyping} \, (\Gamma_1, !^I \Delta |_t \vdash t : \, !^n\alpha \multimap U)$ \\
			 			$\mathcal{L}_u = \text{ConstraintTyping} \, (\Gamma_2, !^I \Delta |_u \vdash u : \, !^n\alpha)$
			 		\end{tabular}
			 		\end{center}
			 	Let $\mathcal{L'}_t$ and $\mathcal{L'}_u$ be
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\mathcal{L'}_t = \text{ConstraintTyping} \, (\Gamma_1, !^I \Delta \vdash t : \, !^n\alpha \multimap U)$ \\
			 			$\mathcal{L'}_u = \text{ConstraintTyping} \, (\Gamma_2, !^I \Delta \vdash u : \, !^n\alpha)$
			 		\end{tabular}
			 		\end{center}
			 	By application of the lemma \ref{red-context}, $\mathcal{L}_t \subseteq \mathcal{L'}_t$ and $\mathcal{L}_u \subseteq \mathcal{L'}_u$.
			 	Let $\sigma$ be the substitution $\sigma = [\, !^n\alpha \mapsto T]$. By application of the lemma \ref{tau-context}, 
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\text{ConstraintTyping} \, (\Gamma_1, !^I \Delta \vdash t : T \multimap U) = \sigma \mathcal{L'}_t$ \\
			 			$\text{ConstraintTyping} \, (\Gamma_2, !^I \Delta \vdash u : T) = \sigma \mathcal{L'}_u$
			 		\end{tabular}
			 		\end{center}
			 	From the induction hypothesis, it follows that there exist $\tau_1$ and $\tau_2$, such that
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\mathcal{L}_1 \vdash (\tau_1 \circ \sigma) \mathcal{L'}_t$ \\
			 			$\mathcal{L}_2 \vdash (\tau_2 \circ \sigma) \mathcal{L'}_u$
			 		\end{tabular}
			 		\end{center}
			 	Thus,
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\mathcal{L}_1 \vdash (\tau_1 \circ \sigma) \mathcal{L}_t$ \\
			 			$\mathcal{L}_2 \vdash (\tau_2 \circ \sigma) \mathcal{L}_u$
			 		\end{tabular}
			 		\end{center}
			 	Moreover, the substitutions $\tau_1$ and $\tau_2$ map variables fresh in the current context, with the
			 	additional property $|\tau_1| \cap |\tau_2| = \varnothing$. Thus, they can be composed without any ambiguity, and
			 		\begin{center}
			 		\begin{tabular}{lcl}
			 			$(\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L'}$ & $=$ & 
				 			$(\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}_t \cup (\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}_u \cup \{1 \le I\}$ \\
				 		& $=$ & $(\tau_1 \circ \sigma) \mathcal{L}_t \cup (\tau_2 \circ \sigma) \mathcal{L}_u \cup \{1 \le I\}$
			 		\end{tabular}
			 		\end{center}
			 	Consequently,
			 		$$ \mathcal{L} \vdash (\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L'} $$
			 		
			\item $(\otimes.I)$. The typing rule is
				\begin{prooftree}
					\AxiomC{$\Gamma_1, !^I\Delta \vdash_{\mathcal{L}_1} t : \,!^nA$}
					\AxiomC{$\Gamma_2, !^I\Delta \vdash_{\mathcal{L}_2} u : \,!^mB$}
					\RightLabel{$(app)$}
					\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_\mathcal{L} \pair{t}{u} : \,!^p(!^nA \otimes \,!^mB)$}
				\end{prooftree}
				with $\mathcal{L} = \mathcal{L}_1 \cup \mathcal{L}_2 \cup \{ 1 \le I, p \le n, p \le m \}$.
				This case is greatly similar to the typing rule $(app)$, in the sense that it relies upon a division of the context.
				The same properties proved in case $(app)$ again hold.
				With $\Lambda = \Gamma_1, \Gamma_2, !^I \Delta$,
				the constraint typing algorithm inputs the non-separated set $\Lambda$, and makes two recursive calls
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\text{ConstraintTyping} \, (\Lambda |_t \vdash t : \, !^a\alpha) = \mathcal{L}_t$ \\
			 			$\text{ConstraintTyping} \, (\Lambda |_u \vdash u : \, !^b\beta) = \mathcal{L}_u$
			 		\end{tabular}
			 		\end{center}
			 	and returns the set
			 		$$ \mathcal{L'} = \mathcal{L}_t \cup \mathcal{L}_u \cup \{ 1 \le I', c \le a, c \le b \} \cup
			 			\{ \,!^c(!^a\alpha \otimes \,!^b\beta) <: \,!^p(!^nA \otimes \,!^mB) \} $$
			 	where $!^{I'} \Delta = \Lambda \backslash_{FV(t) \oplus FV(u)}$.
			 	The reasoning from the case of the application still holds with the substitution
			 	$\sigma = [\, !^a\alpha \mapsto \,!^nA, ~!^b\beta \mapsto \,!^mB, ~ c \mapsto p ]$.
			 	From the induction hypothesis (and the reasoning of case $(app)$), it follows that there exist $\tau_1$ and $\tau_2$, such that
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\mathcal{L}_1 \vdash (\tau_1 \circ \sigma) \mathcal{L}_t$ \\
			 			$\mathcal{L}_2 \vdash (\tau_2 \circ \sigma) \mathcal{L}_u$
			 		\end{tabular}
			 		\end{center}
				The substitutions $\tau_1$ and $\tau_2$ can be composed, and commute, giving
			 		\begin{center}
			 		\begin{tabular}{lcl}
			 			$(\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}'$ & $=$ & 
				 			$(\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}_t \cup (\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}_u \cup
				 				\{1 \le I, p \le n, p \le m\}$ \\
				 	 	&& $\cup \{ \,!^p(!^nA \otimes \,!^mB) <: \,!^p(!^nA \otimes \,!^mB) \} $ \\
				 		& $=$ & $(\tau_1 \circ \sigma) \mathcal{L}_t \cup (\tau_2 \circ \sigma) \mathcal{L}_u \cup
				 				\{1 \le I, p \le n, p \le m\}$ \\
				 	 	&& $\cup \{ \,!^p(!^nA \otimes \,!^mB) <: \,!^p(!^nA \otimes \,!^mB) \} $
			 		\end{tabular}
			 		\end{center}
			 	Consequently,
			 		$$ \mathcal{L} \vdash (\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L'} $$
			 		
			\item $(\otimes.E)$. The typing rule is
				\begin{prooftree}
					\AxiomC{$\Gamma_1, !^I\Delta \vdash_{\mathcal{L}_1} t : \,!^p(!^nA \otimes \,!^mB)$}
					\AxiomC{$\Gamma_2, !^I\Delta, x : \,!^nA, y : \,!^mB \vdash_{\mathcal{L}_2} u : T$}
					\RightLabel{$(\otimes.E)$}
					\BinaryInfC{$\Gamma_1, \Gamma_2, !^I\Delta \vdash_\mathcal{L} ~\text{let}~\pair{x}{y} = t ~\text{in}~ u : T$}
				\end{prooftree}
				with $\mathcal{L} = \mathcal{L}_1 \cup \mathcal{L}_2 \cup \{ 1 \le I, p \le n, p \le m \}$.
				This case is again similar to the one of typing rule $(app)$.
				The constraint typing algorithm inputs the non-separated set $\Lambda$, and makes two recursive calls
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\text{ConstraintTyping} \, (\Lambda |_t \vdash t : \, !^c(!^a\alpha \otimes \,!^b\beta)) = \mathcal{L}_t$ \\
			 			$\text{ConstraintTyping} \, (\Lambda |_u, x : \,!^a\alpha, y : \,!^b\beta \vdash u : T) = \mathcal{L}_u$
			 		\end{tabular}
			 		\end{center}
			 	and returns the set
			 		$$ \mathcal{L''} = \mathcal{L}_t \cup \mathcal{L}_u \cup \{ 1 \le I', c \le a, c \le b \} $$
			 	where $!^{I'} \Delta = \Lambda \backslash_{FV(t) \oplus FV(u)}$.
			 	Let $\sigma$ be the substitution $\sigma = [\, !^a\alpha \mapsto \,!^nA, ~!^b\beta \mapsto \,!^mB, ~ c \mapsto p ]$.
			 	From the induction hypothesis, it follows that there exist $\tau_1$ and $\tau_2$, such that
			 		\begin{center}
			 		\begin{tabular}{l}
			 			$\mathcal{L}_1 \vdash (\tau_1 \circ \sigma) \mathcal{L}_t$ \\
			 			$\mathcal{L}_2 \vdash (\tau_2 \circ \sigma) \mathcal{L}_u$
			 		\end{tabular}
			 		\end{center}
				Thus,
			 		\begin{center}
			 		\begin{tabular}{lcl}
			 			$(\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}'$ & $=$ & 
				 			$(\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}_t \cup (\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L}_u \cup
				 				\{1 \le I, p \le n, p \le m\}$ \\
				 		& $=$ & $(\tau_1 \circ \sigma) \mathcal{L}_t \cup (\tau_2 \circ \sigma) \mathcal{L}_u \cup
				 				\{1 \le I, p \le n, p \le m\}$
			 		\end{tabular}
			 		\end{center}
			 	Consequently,
			 		$$ \mathcal{L} \vdash (\tau_1 \circ \tau_2 \circ \sigma) \mathcal{L'} $$
		\end{itemize}
	\end{proof}
\end{lemma}

\begin{prop} Let $t$ be a term. If there exists a typing derivation $\Pi$ of the typing judgement
	$\Gamma \vdash_\mathcal{L} t : T$, then for all types $T'$ and contexts $\Gamma'$ such that $\sigma T' = T$ and $\sigma \Gamma' = \Gamma$
	for some substitution $\sigma$, the constraint typing algorithm applied to $\Gamma' \vdash t : T'$ outputs a solvable set of
	constraint $\mathcal{L'}$.
	
	\begin{proof}
		Let $\Gamma \vdash_\mathcal{L} t : T$ be a valid typing judgement. Let $T'$, $\Gamma'$ and $\sigma$ be such that
		$\sigma T' = T$ and $\sigma \Gamma' = \Gamma$. By execution of the constraint typing algorithm :
			\begin{center}
			\begin{tabular}{l}
				$\text{ConstraintTyping} \, (\Gamma' \vdash t : T') = \mathcal{L'}$ \\
				$\text{ConstraintTyping} \, (\Gamma \vdash t : T) = \mathcal{L''}$
			\end{tabular}
			\end{center}
		From the lemma \ref{tau-context} we know that $\mathcal{L''} = \sigma \mathcal{L'}$, and from the lemma \ref{incl-set} that
		there exists a substitution $\tau$ such that $\mathcal{L} \vdash \tau \mathcal{L''}$, and
		$|\tau| \cap (FTV(\Gamma) \cup FTV(T)) = \varnothing$. Having a separate domain, the substitutions $\sigma$ and $\tau$ can be composed.
		Thus $\mathcal{L} \vdash (\tau \circ \sigma) \mathcal{L'}$.
		By validity of the typing derivation, the set $\mathcal{L}$ is solvable.
		Let $\rho$ be a solution of $\mathcal{L}$. Then $\rho$ is also a solution of $(\tau \circ \sigma) \mathcal{L'}$, and
		$(\rho \circ \tau \circ \sigma)$ is a solution of $\mathcal{L'}$, which is thus solvable.
	\end{proof}
\end{prop}
 
\begin{lemma}
	\label{rule-subtyping}
	Let $\Gamma \vdash_\mathcal{L} t : T$ be a valid typing judgement in LL'. Let $\Delta$ and $U$ be such that $\Delta <: \Gamma$, $T <: U$.
	Then there exists a set $\mathcal{L'}$ such that the typing judgement $\Delta \vdash_\mathcal{L'} t : U$ is valid and
		$$ \mathcal{L} \cup \{ \Delta <: \Gamma \} \cup \{ T <: U \} \vdash \mathcal{L'} $$
	
	\begin{proof} By induction on the typing derivation $\Pi$ of the typing judgement $\Gamma \vdash t : T$.
		If the last rule used is
		\begin{itemize}
			\item $(ax)$. The typing derivation is
				\begin{prooftree}
					\AxiomC{}
					\RightLabel{$(ax)$}
					\UnaryInfC{$!^I\Gamma, x : V \vdash_{\{1 \le I,~ V <: T\}} x : T$}
				\end{prooftree}
				By application of the rule $(ax)$ of LL', the following typing derivation is valid
				\begin{prooftree}
					\AxiomC{}
					\RightLabel{$(ax)$}
					\UnaryInfC{$!^I\Gamma, x : V \vdash_{\{1 \le I,~ V <: U\}} x : U$}
				\end{prooftree}
				Moreover, can be established	
					\begin{center}
					\begin{tabular}{ll}
						$ \{ !^{I'} \Delta <: \,!^I\Gamma \} \vdash \{ I \le I' \} $ & by the rule $(!)$ of sub-typing \\
						$ \{ V <: T,~ T <: U \} \vdash \{ V <: T \} $ & by transitivity
					\end{tabular}
					\end{center}
				Consequently,
					$$ \{1 \le I,~ V <: T,~ T <: U,~ !^{I'} \Delta <: \,!^I\Gamma \} \vdash \{ I \le I', V <: U \} $$
					
			\item $(\lambda)$. The typing derivation is
				\begin{prooftree}
					\AxiomC{$\Pi$} \noLine
					\UnaryInfC{$!^I\Gamma, x : T \vdash_\mathcal{L} t : U$}
					\RightLabel{$(\lambda)$}
					\UnaryInfC{$!^I\Gamma \vdash_{\mathcal{L} \cup \{n \le I\}} \lambda x.t : \,!^n (T \multimap U)$}
				\end{prooftree}
			We mean to find a set $\mathcal{L''}$ and build a derivation of the typing judgement
			$!^{I'} \Delta \vdash_\mathcal{L''} \lambda x.t : \,!^m (T' \multimap U')$, under the constraints
			$!^{I'} \Delta <: \,!^I\Gamma$ and $!^n (T \multimap U) <: \,!^m(T' \multimap U')$.
			From the rules $(!)$ and $(\multimap)$ of sub-typing, it is necessary that
				$m \le n,~ T' <: T,~ U <: U'$.
			Consequently, the induction hypothesis is applicable and yields a set $\mathcal{L'}$ such that
				\begin{center}
				\begin{tabular}{l}
					$\mathcal{L} \cup \{ !^{I'} \Delta, x : T' <: \,!^I\Gamma, x : T \} \cup \{ U <: U' \} \vdash \mathcal{L'}$ \\
					$!^{I'} \Delta, x : T' \vdash_\mathcal{L'} t : U'$ admits a derivation $\Pi'$
				\end{tabular}
				\end{center}
			By application of the typing rule $(\lambda)$ is built the derivation
				\begin{prooftree}
					\AxiomC{$\Pi'$} \noLine
					\UnaryInfC{$!^{I'}\Delta, x : T' \vdash_\mathcal{L'} t : U'$}
					\RightLabel{$(\lambda)$}
					\UnaryInfC{$!^{I'}\Delta \vdash_{\mathcal{L'} \cup \{m \le I'\}} \lambda x.t : \,!^m (T' \multimap U')$}
				\end{prooftree}
			Finally, the derivations can be proved :
				\begin{center}
				\footnotesize
				\begin{tabular}{rcl}
					$\{ !^{I'} \Delta <: \,!^I \Gamma \} \cup \{ !^n(T \multimap U) <: \,!^m(T' \multimap U') \} \cup \{ n \le I \}$ & $\vdash$ & \\
					$\{ I <: I', m \le n, n \le I \}$ & $\vdash$ & $\{ m \le I' \}$	
				\end{tabular}
				\end{center}
			On the whole,
				$$ \mathcal{L''} \cup \{ !^{I'} \Delta <: \,!^I \Gamma \} \cup \{ !^n(T \multimap U) <: \,!^m(T' \multimap U') \} \vdash
					\mathcal{L'} \cup \{ m \le I' \} $$
									
			\item $(app)$. The typing derivation is
				\begin{prooftree}
					\AxiomC{$\Pi_1$} \noLine
					\UnaryInfC{$\Gamma_1, !^I \Delta \vdash_{\mathcal{L}_1} t : T \multimap U$}
					\AxiomC{$\Pi_2$} \noLine
					\UnaryInfC{$\Gamma_2, !^I \Delta \vdash_{\mathcal{L}_2} u : T$}
					\RightLabel{$(app)$}
					\BinaryInfC{$\Gamma_1, \Gamma_2, !^I \Delta \vdash_\mathcal{L} t u : U$}
				\end{prooftree}
				with $\mathcal{L} = \mathcal{L}_1 \cup \mathcal{L}_2 \cup \{ 1 \le I \}$.
				We mean to find a set $\mathcal{L'}$ and build a typing derivation of the typing judgement
				$\Gamma_1', \Gamma_2', !^{I'}\Delta' \vdash_\mathcal{L'} t u : U'$, with the constraints
				$\Gamma_1', \Gamma_2', !^{I'}\Delta' <: \Gamma_1, \Gamma_2, !^I\Delta$ and $U <: U'$.
				By application of the rule $(\lambda)$ of sub-typing, $T \multimap U <: T \multimap U'$. The induction
				hypothesis applied to $\Pi_1$ and $\Pi_2$ yields two sets $\mathcal{L'}_1$ and $\mathcal{L'}_2$ such that
					\begin{center}
					\begin{tabular}{l}
						$\mathcal{L}_1 \cup \{ \Gamma_1', !^{I'} \Delta' <: \Gamma_1, !^I \Delta \} \cup \{ T \multimap U <: T \multimap U' \} \vdash
							\mathcal{L'}_1$ \\
						$\mathcal{L}_2 \cup \{ \Gamma_2', !^{I'} \Delta' <: \Gamma_2, !^I \Delta \} \cup \{ T <: T \} \vdash
							\mathcal{L'}_2$ \\
						$\Gamma_1', !^{I'} \Delta \vdash_{\mathcal{L}_1'} t : T \multimap U'$ admits a derivation $\Pi_1'$ \\
						$\Gamma_2', !^{I'} \Delta \vdash_{\mathcal{L}_2'} t : T$ admits a derivation $\Pi_2'$
					\end{tabular}
					\end{center}
				By application of the typing rule $(app)$, the following derivation is constructed
				\begin{prooftree}
					\AxiomC{$\Pi_1'$} \noLine
					\UnaryInfC{$\Gamma_1', !^{I'} \Delta' \vdash_{\mathcal{L}_1'} t : T \multimap U'$}
					\AxiomC{$\Pi_2'$} \noLine
					\UnaryInfC{$\Gamma_2, !^{I'} \Delta' \vdash_{\mathcal{L}_2'} u : T$}
					\RightLabel{$(app)$}
					\BinaryInfC{$\Gamma_1', \Gamma_2', !^{I'} \Delta' \vdash_{\mathcal{L}'} t u : U'$}
				\end{prooftree}
				where $\mathcal{L'} = \mathcal{L'}_1 \cup \mathcal{L'}_2 \cup \{ 1 \le I' \}$.
				With the property $\{ !^{I'} \Delta' <: !^I \Delta \} \vdash \{ I \le I' \}$, putting everything together
					$$ \mathcal{L} \cup \{ \Gamma_1', \Gamma_2', !^{I'} \Delta' <: \Gamma_1, \Gamma_2, !^I \Delta \} \cup \{ U <: U' \} \vdash
						\mathcal{L'} $$
		\end{itemize}
			
	\end{proof}
\end{lemma}

\begin{prop} Let $t$ be a term, $T$ a LL' type and $\Gamma$ a context. If the return set $\mathcal{L}$ of the constraint typing
	algorithm is solvable, then there exists a set $\mathcal{L'}$ such that $\mathcal{L} \vdash \mathcal{L'}$ and
	the typing judgement $\Gamma \vdash_\mathcal{L'} t : T$ is valid.
	
	\begin{proof}
		By induction on the form of the term $t$.
		If the term is
		\begin{itemize}
			\item $x$, the algorithm applied to $!^I \Gamma, x : T \vdash x : U$ produces the set
				$\mathcal{L} = \{ T <: U \} \cup \{ 1 \le I \}$. $\mathcal{L}$ being solvable, the typing derivation
				\begin{prooftree}
					\AxiomC{}
					\RightLabel{$(ax)$}
					\UnaryInfC{$!^I \Gamma, x : T \vdash_\mathcal{L} x : U$}
				\end{prooftree}
				holds.
				
			\item $t u$, the algorithm applied to $\Gamma \vdash t u : T$ makes two recursive calls
					\begin{center}
					\begin{tabular}{c}
						$\text{ConstraintTyping}\,(\Gamma|_t \vdash t : \,!^n\alpha \multimap T) = \mathcal{L}_1$ \\
						$\text{ConstraintTyping}\,(\Gamma|_u \vdash u : \,!^n\alpha) = \mathcal{L}_2$
					\end{tabular}
					\end{center}
				where $\alpha$ and $n$ are fresh.
				The output of the algorithm is the set $\mathcal{L} = \mathcal{L}_1 \cup \mathcal{L}_2 \cup \{ 1 \le I \}$, $I$ being defined as
				the annotation vector of $!^I \Delta = \Gamma |_{FV(t) \oplus FV(u)}$.
				Since $\mathcal{L}$ is solvable, so are $\mathcal{L}_1$ and $\mathcal{L}_2$.
				The induction hypothesis applied twice yields the typing derivations
					\begin{prooftree}
						\AxiomC{$\Pi_1$}
						\UnaryInfC{$\Gamma|_t \vdash_{\mathcal{L'}_1} t : \,!^n\alpha \multimap T$}
					\end{prooftree}
					\begin{prooftree}
						\AxiomC{$\Pi_2$}
						\UnaryInfC{$\Gamma|_u \vdash_{\mathcal{L'}_2} t : \,!^n\alpha$}
					\end{prooftree}
				with $\mathcal{L}_1 \vdash \mathcal{L'}_1$ and $\mathcal{L}_2 \vdash \mathcal{L'}_2$.
				It has been shown that $\Gamma|_t = \Gamma_1, \,!^I\Delta|_t$ and $\Gamma|_u = \Gamma_2, \,!^I\Delta|_u$.
				The derivations $\Pi_1$ and $\Pi_2$ can be weakened to be derivations of
 						\begin{center}
 						\begin{tabular}{l}
 							$\Gamma_1, \,!^I\Delta \vdash_{\mathcal{L'}_1 \cup \{ 1 \le I_1 \}} t : \,!^n\alpha \multimap T$ \\
							$\Gamma_2, \,!^I\Delta \vdash_{\mathcal{L'}_2 \cup \{ 1 \le I_2 \}} u : !^n\alpha$
						\end{tabular}
						\end{center}
				with $I_1$ and $I_2$ being the annotation of the additional bindings added to each of the derivations.
				Clearly, $I_1 \subseteq I$ and $I_2 \subseteq I$.
				
				Using both derivations $\Pi_1$ and $\Pi_2$ and the typing rule $(app)$ of LL, we obtain a valid typing derivation of
				$\Gamma \vdash_\mathcal{L'} t u : T$, with $\mathcal{L'} = \mathcal{L'}_1 \cup \mathcal{L'}_2 \cup \{ 1 \le I \}$.
					\begin{prooftree}
						\AxiomC{$\Pi_1$} \noLine
						\UnaryInfC{$\Gamma_1, \,!^I\Delta \vdash_{\mathcal{L'}_1 \cup \{ 1 \le I_1 \}} t : \,!^n\alpha \multimap T$}
						\AxiomC{$\Pi_2$} \noLine
						\UnaryInfC{$\Gamma_2, \,!^I\Delta \vdash_{\mathcal{L'}_2 \cup \{ 1 \le I_2 \}} t : \,!^n\alpha$}
						\RightLabel{$(app)$}
						\BinaryInfC{$\Gamma \vdash_\mathcal{L'} t u : T$}
					\end{prooftree}
				The condition $\mathcal{L} \vdash \mathcal{L'}$ is respected as well.
					
			\item $\lambda x.t$, the algorithm makes one recursive call on $!^I \Gamma, x : \,!^n \alpha \vdash t : \,!^m\beta$, producing the
				set $\mathcal{L}$. The output of the algorithm is then
					$\mathcal{L^*} = \mathcal{L} \cup \{ !^p(!^n \alpha \multimap \,!^m\beta) <: T \} \cup \{p \le I\}$. Since $\mathcal{L^*}$
					is solvable, so is $\mathcal{L}$. By the induction hypothesis, we can build a valid typing derivation $\Pi$ of the
					typing judgement $!^I \Gamma, x :\, !^n \alpha \vdash_\mathcal{L'} t : \beta$, with $\mathcal{L} \vdash \mathcal{L'}$,
					from which we can derive, by application of the rule $(\lambda)$ :
						\begin{prooftree}
							\AxiomC{$\Pi$} \noLine
							\UnaryInfC{$!^I \Gamma, x :\, !^n \alpha \vdash_\mathcal{L'} t : \,!^m\beta$}
							\RightLabel{$(\lambda)$}
							\UnaryInfC{$!^I \Gamma \vdash_{\mathcal{L'} \cup \{p \le I\}} \lambda x.t :\, !^p(!^n \alpha \multimap \,!^m\beta)$}
						\end{prooftree}
					Using the constraint $!^p(!^n\alpha \multimap \,!^m\beta) <: T$, the application of the lemma \ref{rule-subtyping} yields
					a set $\mathcal{L^{**}}$ such that
						\begin{center}
						\begin{tabular}{l}
							$\mathcal{L'} \cup \{p \le I \} \cup \{ \,!^p(!^n\alpha \multimap \,!^m\beta) <: T \} \vdash \mathcal{L^{**}}$ \\
							$!^I \Gamma \vdash_\mathcal{L^{**}} \lambda x.t : T$ is a valid typing judgement
						\end{tabular}
						\end{center}
					Since $\mathcal{L} \vdash \mathcal{L'}$, it follows that $\mathcal{L^*} \vdash \mathcal{L^{**}}$.
				
			\item $\pair{t}{u}$. The algorithm applied to $\Gamma \vdash \pair{t}{u} : T$ makes two recursive calls
					\begin{center}
					\begin{tabular}{c}
						$\text{ConstraintTyping}\,(\Gamma|_t \vdash t : \,!^n\alpha) = \mathcal{L}_1$ \\
						$\text{ConstraintTyping}\,(\Gamma|_u \vdash u : \,!^m\beta) = \mathcal{L}_2$
					\end{tabular}
					\end{center}
				where $\alpha, \beta$ and $n, m, p$ are fresh.
				The output of the algorithm is the set
					$$\mathcal{L} = \mathcal{L}_1 \cup \mathcal{L}_2 \cup \{ 1 \le I,~ p \le n,~ p \le m \} \cup
						\{ \,!^p(!^n\alpha \otimes \,!^m\beta) <: T \}$$
				$I$ being defined as the annotation vector of $!^I \Delta = \Gamma |_{FV(t) \oplus FV(u)}$.
				Since $\mathcal{L}$ is solvable, so are $\mathcal{L}_1$ and $\mathcal{L}_2$.
				The induction hypothesis applied twice, yields the typing derivations which, modified in the same way as in the application
				case, are
					\begin{prooftree}
						\AxiomC{$\Pi_1$}
						\UnaryInfC{$\Gamma_1, \,!^I\Delta \vdash_{\mathcal{L'}_1 \cup \{ 1 \le I_1\} } t : \,!^n\alpha$}
					\end{prooftree}
					\begin{prooftree}
						\AxiomC{$\Pi_2$}
						\UnaryInfC{$\Gamma_2, \,!^I\Delta \vdash_{\mathcal{L'}_2 \cup \{ 1 \le I_2\} } t : \,!^m\beta$}
					\end{prooftree}
				with $\mathcal{L}_1 \vdash \mathcal{L'}_1$ and $\mathcal{L}_2 \vdash \mathcal{L'}_2$.
				Again, $I_1 \subseteq I$ and $I_2 \subseteq I$.
				
				Using both derivations $\Pi_1$ and $\Pi_2$ and the typing rule $(\otimes.I)$ of LL, we obtain a valid typing derivation of
				$\Gamma \vdash_\mathcal{L'} \pair{t}{u} : \,!^p (!^n \alpha \otimes \,!^m\beta) $, with
				$\mathcal{L'} = \mathcal{L'}_1 \cup \mathcal{L'}_2 \cup \{ 1 \le I, p \le n, p \le m \}$.
				Finally, using the constraint $!^p(!^n \alpha \otimes \,!^m\beta) <: T$ and the lemma \ref{rule-subtyping}, we obtain
				a set $\mathcal{L^*}$ such that
					\begin{center}
					\begin{tabular}{l}
						$ \mathcal{L'} \cup \{ \,!^p(!^n\alpha \multimap \,!^m\beta) <: T \} \vdash \mathcal{L^*}$ \\
						$ \Gamma \vdash_\mathcal{L^*} \pair{t}{u} : T$ is a valid typing judgement
					\end{tabular}
					\end{center}
				Moreover, since $\mathcal{L}_1 \vdash \mathcal{L'}_1$ and $\mathcal{L}_2 \vdash \mathcal{L'}_2$, the derivation
				$\mathcal{L} \vdash \mathcal{L'} \cup \{ \,!^p(!^n\alpha \multimap \,!^m\beta) <: T \}$ is verified.
				Consequently, $\mathcal{L} \vdash \mathcal{L^*}$.
				
			\item $\text{let}~ \pair{x}{y} = t ~\text{in}~ u$.
				This case is similar to the others, only longer, this is why it will not be treated here.
		\end{itemize}
	\end{proof}
\end{prop}

\section{Unification Algorithm}

\subsection{Algorithm}

The unification process is divided into two parts, one addressing the problem of unifying the sub-typing constraints,
the latter aiming to solve the remaining flag constraints.

\begin{defn}{Reduction of composite constraints}
	All the composite constraints produced by either the constraint typing
  algorithm or the unification algorithm are automatically reduced, using the following reduction rules.
  If the constraint $c$ is :
  	\begin{itemize}
      \item $T \multimap U <: T' \multimap U'$, replace $c$ by $T' <: T$ and $U <: U'$
      \item $T \otimes U <: T' \otimes U'$, replace $c$ by $T <: T'$ and $U <: U'$
      \item $!^n T <: \, !^m U$, replace $c$ by $T <: U$ and $m \le n$
      \item For any other composite constraint, the algorithm fails
    \end{itemize}
  When all the composite constraints have been reduced, there remains a set of constraints either atomic ($\alpha <: \beta$) or
  semi-composite ($T <: \alpha$ or $\alpha <: T$).
  This automated reduction is justified in the sense that, due to the sub-typing relation rules, a set and its reduced version
  have the exactly the same solutions.
\end{defn}

\begin{defn}{Variable Ordering}
	The type unification relies on an ordering of the type variables, that ensures the termination of the algorithm, and gives a upper
	bound to its complexity (even though the limit itself is exponential).
	The goal is to sort variables topologically, from youngest to oldest. In particular,
  the youngest variable may not appear in any composite type. This is done by defining an age for every variable, with the
  relations :
  	\begin{center}
  	\begin{tabular}{l}
  	  For all constraint $\alpha <: T$ or $T <: \alpha$, $\forall \beta \in FV(T), ~ Age (\alpha) < Age (\beta)$ \\
  	  For all constraint $\alpha <: \beta$, $Age (\alpha) = Age (\beta)$
  	\end{tabular}
  	\end{center}
  	The algorithm may fail to attribute an age to each variable, for example with the constraint $\alpha <: \alpha \multimap \beta$, which gives the
  	relation in the age of $\alpha$ : $A(\alpha) < A(\alpha)$. This is true for all infinite types.
  	There exists an algorithm that gives the minimum (or maximum) of such a poset in linear time in the number of variables and relations
  	(that relies upon a in-depth exploration of the associated graph).
\end{defn}

\begin{defn}{Type Unification} \\
	The algorithm TypeUnification inputs a set of linear constraints $\mathcal{L}$, and returns
	a substitutions $\sigma$ associated with a set of atomic constraints $\mathcal{L'}$.
	The algorithm proceeds as follow : \\
	\\
  Let $\alpha_1 \dots \alpha_n$ be the the youngest variables. The constraint set $\mathcal{L}$ is formed of the constraints
  $\mathcal{L'} \cup \{ \alpha_i <: \alpha_j \} \cup \{ T_{i, 1} \dots T_{i, k_i} <: \alpha_i <: U_{i, 1} \dots U_{i, l_i} \}$.
  The set $\mathcal{L'}$ contains all the constraints unrelated to $\alpha_1 \dots \alpha_n$,
  and the linear types $T_{1, 1} \dots U_{n, l_n}$ are all composite.
  		
  Depending on the types $T_{1, 1} \dots U_{n, l_n}$ :
	\begin{itemize}
		\item If this set is empty, then \\
			\begin{tabular}{l}
				let $\sigma, \mathcal{L''} = ~\text{TypeUnification}\,(\mathcal{L'})$ \\
				return $\sigma, \mathcal{L''} \cup \{ \alpha_i <: \alpha_j \}$
			\end{tabular}
	  
	  \item If not, it contains an element $V = V^1 \,\bullet \, V^2$, with $\bullet$ one in $\{ \otimes, \multimap \}$.
	  	\begin{tabular}{l}
	  		for each $\alpha_i$ \\
	  		~~ let $n_i, m_i, \beta_i, \gamma_i$ be fresh \\
	  		~~ map $\alpha_i$ to $!^{n_i} \beta_i ~\bullet~ !^{m_i}\gamma_i$ in $\sigma$ \\
	  		substitute $\alpha_1 \dots \alpha_n$ in $\mathcal{L}$ \\
	  		reduce $\mathcal{L}$ \\
	  		let $\sigma', \mathcal{L''} = ~\text{TypeUnification}\,(\mathcal{L})$ \\
	  		return $\sigma' \circ \sigma, \mathcal{L''}$
	  	\end{tabular}
  \end{itemize}

  Of course, if the set of sub-typing constraint is empty, then the algorithm stops.
  TypeUnification can fail in two different ways : either it attempted to construct an infinite
  type, an the variable ordering failed, or the reduction encountered an absurd composite constraint.
\end{defn}

\begin{defn}{Flag unification}
	The algorithm inputs a set of atomic constraints, and returns a substitution $\sigma$ on flags, along with
	the remaining constraints (all atomic).
	
	The algorithm looks for constraints of the form
	\begin{itemize}
		\item $1 \le n$, in which case it removes the constraint, and sets $n$ to $1$
		\item $n \le 0$, in which case it removes the constraint, and sets $n$ to $0$
	\end{itemize}	
	When setting a flag to a value, it also needs to replace the instances of this flag in the constraint set.
	If no such constraints remains, it returns. The algorithm fails if and only if it encounters a absurdity,
	as in the case of the set $\{ 1 \le n, n \le 0 \}$.
\end{defn}

\subsection{Termination and correctness}

\begin{defn} Let $\mathcal{L}$ be a constraint set. For the purpose of the proof of termination, the following notations are introduced :
	\begin{itemize}
		\item[$\#\mathcal{L}$] for the complexity of $\mathcal{L}$, given by the number of connectives $\multimap$ and
			$\otimes$ used in the types of the sub-typing constraints
		\item[$|\mathcal{L}|$] for the number of constraints (sub-typing and flag) of $\mathcal{L}$
	\end{itemize}
	The index of $\mathcal{L}$ is defined as pair $(\#\mathcal{L}, |\mathcal{L}|)$, equipped with the lexicographical order.
\end{defn}

\begin{lemma}{Termination}
	\textit{For all constraint sets $\mathcal{L}$, the unification algorithm applied to $\mathcal{L}$ terminates. }
	\begin{proof}
		By induction on indexed sets (see definition above)
		\begin{itemize}
			\item If the index is $(0, N)$, then $\mathcal{L}$ is only composed of atomic constraints, and TypeUnification returns
				immediately when applied to $\mathcal{L}$.
				
			\item If the index is $(C, N)$.
				Let $\alpha_1 \dots \alpha_n$ be the youngest variables of $\mathcal{L}$. The set $\mathcal{L}$ can
				be split as $\mathcal{L'} \cup \{\alpha_i <: \alpha_j \} \cup \{ T_{i, 1} \dots T_{i, k_i} <: \alpha_i <: U_{i, 1} \dots U_{i, l_i} \}$.
				Depending on the types $T_{1, 1} \dots U_{n, l_n}$ : \\

				If $T_{1, 1} \dots U_{n, l_n}$ is empty, since $\mathcal{L'} \subsetneq \mathcal{L}$, it ensues $N' = |\mathcal{L'}| < N$.
				Moreover, because all the constraints of $\mathcal{L} \,\backslash\, \mathcal{L'}$ are atomic, $C' = \#\mathcal{L'} = C$.
				Consequently, the index $(C', N')$ of $\mathcal{L'}$ is such that $(C', N') \lneq (C, N)$.
				Thus, the induction hypothesis applies, and the function call $\text{TypeUnification}\,(\mathcal{L'})$ terminates, and the same
				for $\text{TypeInference}\,(\mathcal{L})$. \\
							
				If not, it contains $V = V_1 \,\bullet\, V_2$. Since that the variable ordering did not fail, we know for sure that
						$$\alpha_1 \dots \alpha_n ~ \notin ~ \bigcup_{i, k} FV(T_{i, k}) \cup \bigcup_{i, l} FV(U_{i, l})$$
				Each $\alpha_i$ is mapped in $\sigma$ to $!^{n_i} \beta_i ~ \bullet ~ !^{m_i}\gamma_i$.
				The result of the application of the new mappings $\sigma$ to $\mathcal{L}$ is :
			  	\begin{center}
			  	\begin{tabular}{lcl}
			  		$\sigma \mathcal{L}$ & $ = $ & $\mathcal{L'}$ \\
				  	& $ \cup $ & $\{!^{n_i} \beta_i ~ \bullet ~ !^{m_i}\gamma_i <: \,!^{n_j} \beta_j ~ \bullet ~ !^{m_j}\gamma_j \}$ \\
				  	& $ \cup $ & $\{ T_{i, 1} \dots T_{i, k_i} <: \,!^{n_i} \beta_i ~ \bullet ~ !^{m_i}\gamma_i <: U_{i, 1} \dots U_{i, l_i} \}$
				  \end{tabular}
				  \end{center}
       	What remains after reduction of the composite constraints is
					\begin{center}
			  	\begin{tabular}{lcl}
			  		$\sigma \mathcal{L}$ & $ = $ & $\mathcal{L'}$ \\
			  		& $ \cup $ & $\{m_j \le m_i, ~n_j \le n_i, ~\beta_i <: \beta_j, ~\gamma_i <: \gamma_j \}$ \\
			  		& $ \cup $ & $\{ T^1_{i, 1} \dots T^1_{i, k_i} <: \beta_i <: U^1_{i, 1} \dots U^1_{i, l_i} \}$ \\
			  		& $ \cup $ & $\{ T^2_{i, 1} \dots T^2_{i, k_i} <: \gamma_i <: U^2_{i, 1} \dots U^2_{i, l_i} \}$ \\
			  		& $ \cup $ & $\{$ some flag constraints $\}$
			  	\end{tabular}
			  	\end{center}
				depending on the connective $\bullet$, the orientation of the constraints $\beta_i <: \beta_j$ and $T^1_{i, k} <: \beta_i <: U^1_{i, l}$
			  may be reversed, though it is of no consequence to the proof.
			  In the reduction of the constraints $T_{i, 1} \dots T_{i, k_i} <: \alpha_i <: U_{i, 1} \dots U_{i, l_i}$, it is assumed that
			  the types $T_{i, k}$ and $U_{i, l}$ are of the form $T^1_{i, k} ~\bullet~ T^2_{i, k}$ and $U^1_{i, l} ~\bullet~ U^2_{i, l}$. \\
			  Following, the complexity of the reduced constraint set $\sigma \mathcal{L}$ compared to that of the original set $\mathcal{L}$ is :
			  	$$C' = \#\sigma\mathcal{L} = \#\mathcal{L'} + \sum_{i, k} \#T_{i, k} - 1 + \sum_{i, l} \#U_{i, l} - 1 $$
			  which is strictly inferior to $C$, meaning $(C',|\sigma\mathcal{L}|) \lneq (C, N)$. The induction hypothesis holds, and the function
			  call $\text{TypeUnification}\,(\sigma \mathcal{L})$ terminates, giving the termination of the call
			  $\text{TypeUnification}\,(\mathcal{L})$.
			  
		\end{itemize}
	\end{proof}
\end{lemma}

\begin{lemma}{Correctness}
	\textit{Let $\mathcal{L}$ be a constraint set. The unification algorithm applied to $\mathcal{L}$ produces a
		set $\mathcal{L'}$ and a substitution $\sigma$ such that :
			\begin{center}
			\begin{tabular}{ll}
				(a) & for every solution $\tau$ of $\mathcal{L'}$, $\tau \circ \sigma$ is a solution of $\mathcal{L}$ \\
				(b) & for every solution $\rho$ of $\mathcal{L}$, there exists $\tau$ solution of $\mathcal{L'}$ such that $\rho = \tau \circ \sigma$ \\
				(c) & $\sigma \mathcal{L'} = \mathcal{L'}$
			\end{tabular}
			\end{center}}

	\begin{proof}
		The third property (c) is easier to prove than the other two, and the proof will be omitted.
		By induction on indexed sets. If the index is
		\begin{itemize}
			\item $(0, N)	$. $\mathcal{L}$ is composed only of atomic constraints, and TypeUnification returns $\varnothing, \mathcal{L}$.
				The properties (a) and (b) are trivially satisfied.
				
			\item $(C, N)$, and $\mathcal{L} = \mathcal{L'} \cup \{ \alpha_i <: \alpha_j \}$. \\
				Let $\sigma, \mathcal{L''} = ~\text{TypeInference}\,(\mathcal{L'})$. By application of the induction hypothesis, $\sigma$ and
				$\mathcal{L''}$ respect the properties (a) and (b).
					\begin{itemize}
						\item[(a)] Let $\tau$ be a solution of $\mathcal{L''} \cup \{ \alpha_i <: \alpha_j \}$. $\tau$ being a solution of $\mathcal{L''}$,
							the application of the property (a) with $\tau$, $\mathcal{L''}$ and $\sigma$ proves that $\tau \circ \sigma$ is a solution of
							$\mathcal{L'}$. Overall, $\tau \circ \sigma$ is a solution of $\mathcal{L}$.
							
						\item[(b)] Let $\rho$ be a solution of $\mathcal{L}$. The property (b) applied with $\mathcal{L''}$ and $\sigma$ ensures the existence
							of $\tau$ solution of $\mathcal{L''}$ such that $\tau \circ \sigma$ is equal to $\rho$. Moreover, it follows from (c) that
							$\sigma \{ \alpha_i <: \alpha_j \} = \{\alpha_i <: \alpha_j \}$. Thus,
								$$\tau \circ \sigma \{\alpha_i <: \alpha_j \} = \tau \{\alpha_i <: \alpha_j \}$$
							Since $\rho = \tau \circ \sigma$ is a solution of $\{\alpha_i <: \alpha_j \}$, it follows that $\tau$ is a solution of
							$\{\alpha_i <: \alpha_j \}$, and also of $\mathcal{L''} \cup \{\alpha_i <: \alpha_j \}$. This proves the property (b).
					\end{itemize}
			
			\item $(C, N)$, and $\mathcal{L} = \mathcal{L'} \cup \{ \alpha_i <: \alpha_j \} \cup
				\{ T_{i, 1} \dots T_{i, k_i} <: \alpha_i <: U_{i, 1} \dots U_{i, l_i} \}$.
				Let $\sigma$ be the substitution $\sigma = [\alpha_i \mapsto !^{n_i}\beta_i \,\bullet\, !^{m_i}\gamma_i]$, and
				$\mathcal{L}^*$ the reduced set $\sigma \mathcal{L}$. Finally, let $\sigma', \mathcal{L''} = ~\text{TypeUnification}\,(\mathcal{L}~*)$.
				The induction hypothesis applied to $\mathcal{L}^*$ proves that $\sigma', \mathcal{L''}$ respect the properties (a), (b) and (c).
					\begin{itemize}
						\item[(a)] Let $\tau$ be a solution of $\mathcal{L''}$. By application of (b), $\tau \circ \sigma$ is a solution of $\mathcal{L}^*$.
							Since the solutions of $\mathcal{L}^*$ and $\sigma \mathcal{L}$ are the same, $\tau \circ \sigma'$ is also a solution of
							$\sigma \mathcal{L}$. Thence, $\tau \circ \sigma' \circ \sigma$ is a solution of $\mathcal{L}$.
							
						\item[(b)] Let $\rho$ be a solution of $\mathcal{L}$. In particular, $\rho$ contains the mappings :
								$$\rho = \rho' \cup [\alpha_i \mapsto V_i \,\bullet\, W_i]$$
							Thus it can be modified to be :
								$$\rho = (\rho' \cup [!^{n_i}\beta_i \mapsto V_i] \cup [!^{m_i}\gamma_i \mapsto W_i]) \circ
									[\alpha_i \mapsto \,!^{n_i}\beta_i \,\bullet\, !^{m_i}\gamma_i]$$
							Using the notation $\rho^* = \rho' \cup [!^{n_i}\beta_i \mapsto V_i] \cup [!^{m_i}\gamma_i \mapsto W_i]$,
							$\rho = \rho^* \circ \sigma$. By application of the sub-typing relation rules on $\mathcal{L}^*$, it can be proved
							that $\rho^*$ is a solution of $\mathcal{L}^*$. By application of the induction hypothesis and (b), there exists
							$\tau$ solution of $\mathcal{L''}$, such that $\rho^* = \tau \circ \sigma'$. Hence $\rho = \tau \circ \sigma' \circ \sigma$.
					\end{itemize}
		\end{itemize}
	\end{proof}
\end{lemma}


\end{document}